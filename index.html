<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoExplore Sobangan</title>

    <!-- Google Fonts: Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin="" />

    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
        integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Leaflet Control Geocoder CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    
    <style>
        :root {
            /* Warna Tema */
            --primary-color: #086cfc; 
            --primary-color-darker: #0759d3; 
            --primary-font-color: #ffffff; 
            
            --secondary-color: #10B981; 
            --accent-color: #F59E0B; 
            
            --light-gray: #F3F4F6;
            --medium-gray: #D1D5DB;
            --dark-gray: #4B5563; 
            --text-color: #3a2e27; 
            --font-main: 'Poppins', sans-serif;
        }

        body {
            font-family: var(--font-main);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: var(--light-gray);
            color: var(--text-color);
            font-size: 15px; 
        }

        header {
            position: relative; /* Ini penting agar tombol bisa diposisikan di dalamnya */
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--primary-color-darker) 100%);
            color: var(--primary-font-color); 
            padding: 15px 50px; /* Beri ruang untuk tombol di kiri */
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1002; 
        }

        header h1 {
            margin: 0;
            font-size: 1.5em; 
            font-weight: 600;
        }
         header h1 i {
            margin-right: 8px;
            font-size: 0.9em; 
        }

        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        #sidebar {
            width: 320px; 
            background-color: #ffffff;
            padding: 18px;
            overflow-y: auto;
            box-shadow: 2px 0 6px rgba(0,0,0,0.08);
            transition: width 0.3s ease;
            border-right: 1px solid var(--medium-gray);
            z-index: 1001;
            display: flex;
            flex-direction: column;
        }
        
        #sidebar h2 {
            margin-top: 0;
            color: var(--primary-color); 
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            font-size: 1.25em; 
            display: flex;
            align-items: center;
            font-weight: 600;
        }
         #sidebar h2 i {
            margin-right: 8px;
            font-size: 0.9em;
        }
        h2.section-title-lokasi {
            margin-top: 20px !important; 
        }

        .dashboard-stats {
            background-color: var(--light-gray);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 18px;
            border: 1px solid var(--medium-gray);
        }
        .dashboard-stats h3 {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 1.05em; 
            color: var(--dark-gray);
            font-weight: 500;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 7px 0;
            font-size: 0.9em; 
            border-bottom: 1px dashed var(--medium-gray);
        }
        .stat-item:last-child {
            border-bottom: none;
        }
        .stat-item .label {
            color: var(--dark-gray);
            display: flex;
            align-items: center;
        }
        .stat-item .label i {
            margin-right: 6px;
            font-size: 1em; 
        }
        .stat-item .value {
            font-weight: 600;
            color: var(--primary-color); 
        }
        
        .filter-controls {
            margin-bottom: 10px; 
            padding: 10px;
            background-color: var(--light-gray);
            border-radius: 6px;
            border: 1px solid var(--medium-gray);
            overflow: auto; 
        }
        .filter-controls h3 {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 1.05em; 
            color: var(--dark-gray);
            font-weight: 500;
        }
        .filter-controls .leaflet-control-layers {
            position: relative !important;
            float: none !important;
            clear: both !important;
            width: auto !important; 
            margin-top: 5px !important;
            box-shadow: none !important;
            border: none !important;
            background-color: transparent !important; 
            padding: 0 !important;
        }
        .filter-controls .leaflet-control-layers-overlays label {
            font-size: 0.9em;
            display: flex; 
            align-items: center;
            padding: 3px 0; 
            color: var(--text-color); 
        }
        .filter-controls .leaflet-control-layers-overlays input[type="checkbox"] {
            margin-right: 8px; 
            accent-color: var(--primary-color); 
        }
        .filter-controls .leaflet-control-layers-overlays label i {
             margin-right: 5px;
             font-size: 1em;
         }

        #feature-list {
            flex-grow: 1; /* Allow list to grow */
        }
        .sidebar-item {
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 1px solid var(--medium-gray);
            background-color: #fff;
        }

        .sidebar-item:hover {
            background-color: #f7fcff; 
            border-color: var(--primary-color);
            transform: translateX(3px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.04);
        }

        .sidebar-item i.fa-icon { 
            margin-right: 8px;
            font-size: 1em; 
            width: 18px; 
            text-align: center;
        }
        
        .sidebar-item .item-name {
            font-weight: 500;
            font-size: 0.95em; 
        }

        .sidebar-item .item-type {
            font-size: 0.75em; 
            color: #6B7280; 
            display: block;
            margin-top: 2px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        /* --- BARU: Style untuk Credit --- */
        .credits {
            margin-top: auto; /* Mendorong ke bawah */
            padding-top: 15px;
            border-top: 1px solid var(--light-gray);
            text-align: center;
            font-size: 0.8em;
            color: var(--dark-gray);
        }
        .credits p {
            margin: 0;
            line-height: 1.5;
        }
        .credits strong {
            color: var(--text-color);
            font-weight: 600;
        }

        #map {
            flex-grow: 1;
            height: 100%;
            z-index: 0;
        }

        .custom-leaflet-div-icon {
            background: transparent;
            border: none;
        }
        .custom-leaflet-div-icon i.fa-map-marker-alt,
        .custom-leaflet-div-icon i.fa-location-arrow,
        .custom-leaflet-div-icon i.fa-person-hiking { 
            font-size: 30px; 
            text-shadow: 1px 1px 3px rgba(0,0,0,0.4);
        }

        .modal {
            display: none; 
            position: fixed; 
            z-index: 1003; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.65); 
            padding-top: 20px; 
        }

        /* --- Style untuk modal disclaimer --- */
        #disclaimerModal {
            z-index: 1005; /* Paling atas */
            display: none; /* Diatur oleh JS */
            align-items: center;
            justify-content: center;
            padding: 15px;
        }

        #disclaimerModal .modal-content {
            margin: 0;
            animation: fadeInModal 0.4s ease-out;
            max-width: 550px;
        }

        #disclaimerModal .modal-body {
            max-height: none;
            padding-right: 0;
        }

        .disclaimer-footer {
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid var(--light-gray);
            text-align: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 3% auto; 
            padding: 20px 25px;
            border: none; 
            width: 90%; 
            max-width: 650px; 
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.25);
            position: relative;
            animation: fadeInModal 0.3s ease-out;
        }

        @keyframes fadeInModal {
            from { opacity: 0; transform: translateY(-15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .close-button {
            color: #9CA3AF;
            float: right;
            font-size: 24px; 
            font-weight: bold;
            position: absolute;
            top: 12px;
            right: 18px;
            transition: color 0.2s;
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--text-color);
            text-decoration: none;
            cursor: pointer;
        }

        .modal-header h2 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--primary-color); 
            font-size: 1.6em; 
            font-weight: 600;
        }
         .modal-header h2 i {
            margin-right: 10px;
            font-size: 0.9em; 
         }

        .modal-body {
            margin-top: 15px;
            max-height: 65vh;
            overflow-y: auto;
            padding-right: 10px; 
        }
        .modal-body img.main-image {
            width: 100%;
            max-height: 280px; 
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 12px;
            border: 1px solid var(--medium-gray);
        }
        .modal-body h4 {
            color: var(--dark-gray);
            margin-top: 12px;
            margin-bottom: 4px;
            font-size: 1em; 
            font-weight: 600;
        }
         .modal-body h4 i {
            margin-right: 6px;
            font-size: 0.9em;
         }
        .modal-body p, .modal-body ul {
            line-height: 1.6;
            font-size: 0.9rem; 
            margin-bottom: 8px;
        }
        .modal-body ul {
            list-style: none;
            padding-left: 0;
        }
        .modal-body ul li {
            padding: 4px 0;
            border-bottom: 1px dashed var(--medium-gray);
            display: flex;
            align-items: center;
        }
         .modal-body ul li:last-child {
            border-bottom: none;
         }
        .modal-body ul li i.fa-li-icon { 
            margin-right: 8px;
            color: var(--secondary-color);
            width: 18px; 
            font-size: 0.9em;
        }
        .modal-body .contact-link {
            color: var(--primary-color); 
            text-decoration: none;
            font-weight: 500;
        }
        .modal-body .contact-link:hover {
            text-decoration: underline;
        }
        
        .modal-body::-webkit-scrollbar { width: 6px; }
        .modal-body::-webkit-scrollbar-track { background: var(--light-gray); border-radius: 10px; }
        .modal-body::-webkit-scrollbar-thumb { background: var(--medium-gray); border-radius: 10px; }
        .modal-body::-webkit-scrollbar-thumb:hover { background: var(--dark-gray); }

        .route-button-container {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--medium-gray);
        }
        .route-button {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 18px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.95em;
            font-family: var(--font-main);
            font-weight: 500;
            transition: background-color 0.2s ease;
            width: 100%; 
        }
        .route-button:hover {
            background-color: var(--primary-color-darker);
        }
        .route-button i {
            margin-right: 8px;
        }

        /* Style untuk Panel Rute Mirip Google Maps */
        .leaflet-routing-container {
            background-color: white;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            font-family: var(--font-main);
        }

        .leaflet-routing-remove-waypoint {
            display: none !important;
        }

        .leaflet-routing-geocoders {
            position: relative;
            padding: 10px 15px 10px 45px; 
        }

        .leaflet-routing-geocoders::before {
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            content: "\f142"; /* fa-ellipsis-v */
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%) scaleY(1.5);
            color: #ccc;
            font-size: 8px;
            letter-spacing: 2px;
        }

        .leaflet-routing-waypoint {
            position: relative;
            padding: 5px 0;
            margin: 0 !important;
        }

        .leaflet-routing-waypoint:first-child::before {
            font-family: "Font Awesome 6 Free";
            font-weight: 400; 
            content: "\f111"; /* fa-circle */
            position: absolute;
            left: -28px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            font-size: 12px;
            border: 2px solid white;
            box-sizing: content-box;
        }

        .leaflet-routing-waypoint:last-child::before {
            font-family: "Font Awesome 6 Free";
            font-weight: 900; 
            content: "\f3c5"; /* fa-map-marker-alt */
            position: absolute;
            left: -28px;
            top: 50%;
            transform: translateY(-50%);
            color: #d33;
            font-size: 16px;
        }

        .leaflet-routing-geocoder {
            position: relative;
        }

        .leaflet-routing-geocoder input {
            border: 1px solid var(--medium-gray) !important;
            padding: 10px 40px 10px 12px !important; 
            width: 100% !important;
            box-sizing: border-box;
            transition: border-color 0.2s;
            border-radius: 6px !important;
            font-family: var(--font-main);
            font-size: 14px;
        }
        .leaflet-routing-geocoder input:focus {
            border-color: var(--primary-color) !important;
            box-shadow: 0 0 0 3px rgba(8, 108, 252, 0.15);
        }

        .leaflet-routing-geocoder-icon {
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            background-image: none !important;
            top: 0 !important;
            right: 0 !important;
            bottom: 0;
            margin: auto 0;
            width: 40px !important;
            height: 100% !important;
            display: flex !important;
            align-items: center;
            justify-content: center;
            color: #777;
        }
        .leaflet-routing-geocoder-icon::before {
             content: "\f002"; /* fa-search */
        }
        
        .leaflet-routing-geocoders .leaflet-routing-add-waypoint {
            position: absolute;
            right: -25px;
            top: 50%;
            transform: translateY(-50%);
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .leaflet-routing-add-waypoint::before {
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            content: "\f362"; /* fa-exchange-alt */
            transform: rotate(90deg);
            color: #555;
            font-size: 14px;
        }

        .routing-suggestions-container {
            padding: 0 15px 10px 15px;
            border-top: 1px solid var(--light-gray);
            margin-top: 10px;
        }
        .routing-suggestion-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            cursor: pointer;
        }
        .routing-suggestion-item:hover .suggestion-text {
            color: var(--primary-color);
        }
        .routing-suggestion-item .suggestion-icon {
            font-size: 18px;
            color: var(--primary-color);
            background-color: #e7f1ff;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }
        .routing-suggestion-item .suggestion-text {
            font-weight: 500;
            font-size: 14px;
            color: var(--dark-gray);
            transition: color 0.2s;
        }
        
        .leaflet-control-geocoder-alternatives {
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            border: 1px solid var(--medium-gray);
        }
        .leaflet-control-geocoder-alternatives a {
            font-size: 14px;
            padding: 10px 40px;
            position: relative;
        }
        .leaflet-control-geocoder-alternatives a::before {
            font-family: "Font Awesome 6 Free";
            font-weight: 400; 
            content: "\f017"; /* fa-clock */
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #777;
        }
        
        .leaflet-routing-container:not(.leaflet-routing-container-summary) .leaflet-routing-itinerary-container {
            display: none;
        }
        .leaflet-routing-itinerary-container {
            padding: 10px 15px;
            font-size: 14px;
        }
        
        .leaflet-bar a, .leaflet-bar a:hover {
            width: 30px !important;
            height: 30px !important;
            line-height: 30px !important;
        }
        .leaflet-bar a i { 
             color: var(--primary-color);
        }
        .leaflet-bar a:hover i {
            color: var(--primary-color-darker);
        }
        
        .leaflet-control-geocoder {
            border-radius: 4px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        }
        .leaflet-control-geocoder-form input {
            height: 30px !important; 
            border-radius: 4px 0 0 4px;
            border: none; 
            padding-left: 8px;
            font-size: 13px;
        }
         .leaflet-control-geocoder-icon {
            width: 30px !important; 
            height: 30px !important; 
            border-radius: 0 4px 4px 0;
            background-position: center !important;
        }
        .leaflet-touch .leaflet-control-geocoder-icon {
            width: 30px !important;
            height: 30px !important;
        }

        #toggle-sidebar-btn {
            position: absolute;
            top: 50%;
            left: 15px;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--primary-font-color);
            font-size: 1.4em;
            cursor: pointer;
            z-index: 1003;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        #toggle-sidebar-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        #sidebar.closed {
            width: 0;
            padding-left: 0;
            padding-right: 0;
            overflow: hidden;
            border-right: none;
        }

        @media (max-width: 768px) {
            body {
                height: auto;
                display: block;
            }
            header h1 {
                font-size: 1.2em;
            }
            .container {
                flex-direction: column;
                height: auto;
                overflow: visible;
            }

            #sidebar {
                width: 100%;
                max-height: 50vh; 
                box-sizing: border-box; 
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                border-right: none;
                border-bottom: 1px solid var(--medium-gray);
                padding: 15px;
            }
            /* Sembunyikan tombol toggle di HP karena sidebar selalu terbuka di atas */
            #toggle-sidebar-btn {
                display: none;
            }
            #map {
                height: 60vh; 
                flex-grow: 0;
            }
            .modal-content {
                width: 95%; 
                margin: 5% auto; 
                padding: 15px 20px;
            }
            .modal-header h2 {
                font-size: 1.4em;
            }
            .modal-body {
                max-height: 70vh;
            }
            #disclaimerModal .modal-content {
                width: 95%;
                margin: auto;
            }
        }
    </style>
</head>
<body>

    <header>
        <button id="toggle-sidebar-btn" title="Buka/Tutup Dashboard">
            <i class="fas fa-bars"></i>
        </button>
        <h1><i class="fas fa-map-signs"></i> WebGIS Desa Sobangan: Eksplorasi Destinasi Wisata dan UMKM Lokal</h1>
    </header>

    <div class="container">
        <div id="sidebar">
            <div> <!-- Wrapper for scrollable content -->
                <h2><i class="fas fa-tachometer-alt"></i> Dashboard</h2>
                <div class="dashboard-stats">
                    <h3><i class="fas fa-chart-pie"></i> Statistik</h3>
                    <div class="stat-item">
                        <span class="label"><i class="fas fa-map-marker-alt" style="color: var(--secondary-color);"></i> Total Wisata</span>
                        <span class="value" id="total-wisata">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="label"><i class="fas fa-map-marker-alt" style="color: var(--accent-color);"></i> Total UMKM</span>
                        <span class="value" id="total-umkm">0</span>
                    </div>
                </div>

                <div class="filter-controls">
                    <h3><i class="fas fa-filter"></i> Filter Tampilan</h3>
                </div>

                <h2 class="section-title-lokasi"><i class="fas fa-list-ul"></i> Daftar Lokasi</h2>
                <div id="feature-list">
                    <!-- Items will be populated by JavaScript -->
                </div>
            </div>

            <!-- --- BARU: Bagian Credit --- -->
            <div class="credits">
                <p>Dibuat oleh: <br>
                <strong>Maureen Arsa Sanda Cantika</strong><br>
                Sistem Informasi Geografis<br>
                KKN PPM UGM Gantari Mengwi 2025</p>
            </div>
        </div>
        <div id="map"></div>
    </div>

    <div id="infoModal" class="modal">
        <div class="modal-content">
            <span class="close-button">×</span>
            <div class="modal-header">
                <h2 id="modalTitle"><i class="fas fa-info-circle"></i> Detail Informasi</h2>
            </div>
            <div class="modal-body" id="modalBodyContent">
            </div>
        </div>
    </div>

    <div id="disclaimerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-exclamation-triangle"></i> Disclaimer</h2>
            </div>
            <div class="modal-body">
                <p>Selamat datang di WebGIS Desa Sobangan.</p>
                <p>Data dan informasi yang tersedia dalam halaman ini, termasuk lokasi titik, deskripsi, dan foto, disusun sebagai layanan informasi publik. Informasi ini bertujuan untuk mempromosikan potensi wisata dan UMKM di wilayah Desa Sobangan.</p>
                <p>Meskipun kami berusaha menyajikan data seakurat mungkin, tidak ada jaminan bahwa semua informasi 100% akurat, lengkap, atau terkini. Pengguna disarankan untuk melakukan verifikasi mandiri sebelum mengunjungi lokasi.</p>
                <p><b>Dengan menekan tombol di bawah, Anda dianggap memahami dan menerima ketentuan ini.</b></p>
                <div class="disclaimer-footer">
                     <button id="disclaimerCloseBtn" class="route-button" style="width: auto; padding: 10px 25px;">Saya Mengerti & Lanjutkan</button>
                </div>
            </div>
        </div>
    </div>


    <!-- SCRIPT SECTION -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    
    <script>
        // --- PENDEFINISIAN VARIABEL DAN KONSTANTA DATA ---
        const initialCoords = [-8.502, 115.192]; 
        const dataWisata = [
            { id: "wisata3", nama: "Tugu Pahlawan Kapten Tjok. Agung Tresna", lat: -8.497394, lng: 115.195481, deskripsi_singkat: "Monumen untuk mengenang jasa pahlawan.", deskripsi_detail: "Tugu Pahlawan Kapten Tjok. Agung Tresna merupakan sebuah monumen bersejarah yang berdiri kokoh di Desa Sobangan sebagai wujud penghormatan abadi atas jasa dan pengorbanan heroik Kapten Anumerta Tjokorda Agung Tresna. Lokasi ini memiliki makna yang mendalam, karena Desa Sobangan pernah menjadi Markas Besar Pandawa, pusat komando perjuangan gerilya yang dipimpin oleh Kapten Tjok. Agung Tresna melawan tentara NICA. Dibangun atas inisiatif dan swadaya masyarakat setempat sekitar tahun 1953, pendirian tugu ini juga dilandasi oleh sebuah keyakinan spiritual setelah munculnya pertanda gaib yang diyakini sebagai keinginan arwah sang pahlawan untuk diabadikan di tanah tempat ia berjuang bersama rakyat yang setia. Lebih dari sekadar penanda fisik, monumen ini adalah simbol ikatan batin yang kuat antara seorang pahlawan dengan masyarakatnya, serta menjadi pengingat sejarah perjuangan kemerdekaan bagi seluruh generasi di Desa Sobangan.", gambar: ["./tugu_pahlawan.jpeg"], kategori: "Monumen & Sejarah", fasilitas: ["Area Terbuka", "Akses Umum"], jam_operasional: "Terbuka 24 Jam", iconClass: "fa-map-marker-alt", iconColor: "var(--secondary-color)" },
            { id: "wisata4", nama: "Lapangan Umum Kapten Tjok. Agung Tresna", lat: -8.497291, lng: 115.195171, deskripsi_singkat: "Fasilitas olahraga dan ruang terbuka hijau.", deskripsi_detail: "Mengabadikan nama dan semangat sang pahlawan, Lapangan Umum Kapten Tjok. Agung Tresna merupakan jantung dari kehidupan sosial dan olahraga bagi masyarakat Desa Sobangan. Hamparan rumput hijau yang terawat ini tidak pernah sepi dari aktivitas, mulai dari riuh oleh sorak-sorai anak-anak dan pemuda yang berlatih sepak bola setiap sore, hingga menjadi lokasi utama untuk berbagai perayaan desa, upacara, dan kegiatan rekreasi bersama. Lebih dari sekadar fasilitas olahraga, lapangan ini adalah ruang terbuka tempat terjalinnya kebersamaan, tumbuhnya bibit-bibit atlet lokal, dan dilestarikannya semangat komunal yang menjadi ciri khas warga Desa Sobangan.", gambar: ["./lapangan_bolaumum.jpeg"], kategori: "Olahraga & Rekreasi", fasilitas: ["Lapangan Bola", "Area Terbuka"], jam_operasional: "Terbuka untuk umum", iconClass: "fa-map-marker-alt", iconColor: "var(--secondary-color)" },
            { id: "wisata5", nama: "Uma Pacung Jogging Track", lat: -8.484339, lng: 115.187119, deskripsi_singkat: "Jalur lari di sekitar area persawahan.", deskripsi_detail: "Uma Pacung Jogging Track adalah sebuah oase hijau yang menawarkan pengalaman rekreasi unik di tengah lanskap agraris Desa Sobangan. Jalur aspal mulus ini membentang, mengelilingi kawasan vital Balai Penyuluhan Pertanian (BPP) Mengwi, menjadikannya etalase hidup dari kekayaan pertanian lokal. Sambil berolahraga, pengunjung disuguhi pemandangan sawah berundak yang luas dan asri, dengan warna hijau atau kuning keemasan tergantung pada musim panen. Suasana tenang pedesaan, ditemani semilir angin sejuk dan lambaian pohon kelapa, menjadikan tempat ini lokasi yang sempurna untuk jogging, bersepeda, atau sekadar berjalan santai di pagi dan sore hari. Jalur ini bukan hanya fasilitas olahraga, tetapi juga ruang interaksi dengan alam dan kehidupan petani, memberikan kesempatan untuk melepaskan penat sambil menikmati keindahan otentik pedesaan Bali.", gambar: ["./joggingtrack_kantor_bpp_mengwi.jpeg"], kategori: "Olahraga & Rekreasi", fasilitas: ["Jalur Lari", "Pemandangan Sawah"], jam_operasional: "Terbuka untuk umum", iconClass: "fa-map-marker-alt", iconColor: "var(--secondary-color)" },
            { id: "wisata6", nama: "Jogging Track Munduk Babakan Sobangan", lat: -8.503550, lng: 115.193199, deskripsi_singkat: "Jalur lari dengan pemandangan alam perbukitan.", deskripsi_detail: "Jogging Track Munduk Babakan Sobangan adalah sebuah jalur tersembunyi yang menawarkan pengalaman lari dan berjalan kaki yang benar-benar menyatu dengan alam. Berlokasi di area perbukitan Munduk Babakan yang sejuk, jalur beton ini berkelok-kelok, membelah hamparan mozaik perkebunan subur yang terdiri dari sawah, tanaman palawija, dan dikelilingi oleh rimbunnya pepohonan kelapa. Tempat ini adalah pilihan ideal untuk memulai hari dengan olahraga pagi atau bersantai di sore hari, sambil menghirup udara bersih perbukitan dan menikmati ketenangan pedesaan yang otentik. Jauh dari kebisingan, jalur ini tidak hanya menyehatkan tubuh, tetapi juga menenangkan jiwa dengan pemandangan hijau khas Sobangan yang memanjakan mata.", gambar: ["./munduk_babakan_sobangan_jogging_track.jpeg"], kategori: "Olahraga & Rekreasi", fasilitas: ["Jalur Lari", "Pemandangan Alam", "Area Terbuka"], jam_operasional: "Terbuka untuk umum", iconClass: "fa-map-marker-alt", iconColor: "var(--secondary-color)" }
        ];
        const dataUMKM = [
            { id: "umkm3", nama: "Nang Kisnong Garden", lat: -8.490338522730275, lng: 115.194062022974, deskripsi_singkat: "Pusat bibit tanaman dan perlengkapan berkebun.", deskripsi_detail: "Nang Kisnong Garden menyediakan berbagai macam bibit tanaman hias, pot dalam berbagai ukuran dan bahan, serta media tanam berkualitas. Cocok bagi para penggemar berkebun untuk melengkapi koleksi atau memulai taman baru.", foto_produk: [], kategori: "Perlengkapan Taman", alamat_lengkap: "Sobangan, Kec. Mengwi, Kabupaten Badung, Bali 80351", jam_operasional: "08:00 - 18:00 WITA", kontak_person: "Tidak tersedia", link_ecommerce: null, iconClass: "fa-map-marker-alt", iconColor: "var(--accent-color)" },
            { id: "umkm4", nama: "Raya Koi Bali", lat: -8.491896060727917, lng: 115.18791726834016, deskripsi_singkat: "Toko khusus ikan hias Koi.", deskripsi_detail: "Toko ikan hias yang khusus menjual berbagai jenis ikan Koi berkualitas. Menyediakan juga pakan dan perlengkapan akuarium untuk para penghobi ikan.", foto_produk: [], kategori: "Toko Ikan Hias", alamat_lengkap: "Jl. Surapati, Sobangan, Kec. Mengwi, Kabupaten Badung, Bali 08351", jam_operasional: "07:00 - 22:00 WITA", kontak_person: "Tidak tersedia", link_ecommerce: null, iconClass: "fa-map-marker-alt", iconColor: "var(--accent-color)" },
            { id: "umkm5", nama: "Warung Tipat Cantok 'Ming Bonie'", lat: -8.491428866108134, lng: 115.19432333461874, deskripsi_singkat: "Warung makanan khas Bali, tipat cantok.", deskripsi_detail: "Warung sederhana yang menyajikan tipat cantok, makanan khas Bali dengan bumbu kacang yang lezat. Pilihan populer untuk makan siang atau malam bagi warga sekitar.", foto_produk: [], kategori: "Kuliner", alamat_lengkap: "Sobangan, Kec. Mengwi, Kabupaten Badung, Bali 80351", jam_operasional: "09:00 - 23:00 WITA", kontak_person: "087883985096", link_ecommerce: null, iconClass: "fa-map-marker-alt", iconColor: "var(--accent-color)" },
            { id: "umkm6", nama: "Ianas Cakes", lat: -8.493902257291305, lng: 115.19097642112543, deskripsi_singkat: "Toko kue dan roti rumahan.", deskripsi_detail: "Menyediakan berbagai macam kue, roti, dan jajanan untuk berbagai acara. Dibuat dengan resep rumahan yang lezat dan bahan berkualitas.", foto_produk: [], kategori: "Kuliner", alamat_lengkap: "Jl. Pahlawan No.18, Sobangan, Kec. Mengwi, Kabupaten Badung, Bali 80351", jam_operasional: "08:00 - 17:00 WITA", kontak_person: "Tidak tersedia", link_ecommerce: null, iconClass: "fa-map-marker-alt", iconColor: "var(--accent-color)" },
            { id: "umkm7", nama: "Mahadewi Collection", lat: -8.494375273198429, lng: 115.19232040715166, deskripsi_singkat: "Toko perhiasan dengan rating tinggi.", deskripsi_detail: "Mahadewi Collection adalah sebuah toko perhiasan yang berlokasi di Sobangan, Mengwi. Toko ini dikenal memiliki rating yang sangat baik dari para pelanggannya.", foto_produk: [], kategori: "Toko Perhiasan", alamat_lengkap: "Jl. Pahlawan No.18, Sobangan, Kec. Mengwi, Kabupaten Badung, Bali 80351", jam_operasional: "10:00 - 19:00 WITA", kontak_person: "0878-6030-5641", link_ecommerce: null, iconClass: "fa-map-marker-alt", iconColor: "var(--accent-color)" },
            { id: "umkm8", nama: "Warung Mina", lat: -8.496082185944866, lng: 115.19291865599867, deskripsi_singkat: "Toko bahan makanan.", deskripsi_detail: "Warung mina adalah sebuah toko yang menjual berbagai macam bahan makanan untuk kebutuhan sehari-hari.", foto_produk: [], kategori: "Toko Bahan Makanan", alamat_lengkap: "Jl. Pahlawan, Sobangan, Kec. Mengwi, Kabupaten Badung, Bali 80351", jam_operasional: "Tidak tersedia", kontak_person: "Tidak tersedia", link_ecommerce: null, iconClass: "fa-map-marker-alt", iconColor: "var(--accent-color)" },
            { id: "umkm9", nama: "Pengerajin Rindik Buluh Perindu", lat: -8.500581774198764, lng: 115.19663883899838, deskripsi_singkat: "Pengrajin dan toko alat musik tradisional Rindik.", deskripsi_detail: "Pengerajin Rindik Buluh Perindu adalah sebuah toko yang menjual alat musik tradisional Bali, yaitu Rindik. Toko ini mendapatkan rating sempurna dari pelanggannya.", foto_produk: [], kategori: "Kerajinan Tangan", alamat_lengkap: "Jl. Pejuang 45, Sobangan, Kec. Mengwi, Kabupaten Badung, Bali 80351", jam_operasional: "08:00 - 18:00 WITA", kontak_person: "0878-6192-4257", link_ecommerce: null, iconClass: "fa-map-marker-alt", iconColor: "var(--accent-color)" },
            { id: "umkm10", nama: "Biren Cakes", lat: -8.50072981847206, lng: 115.18964243657388, deskripsi_singkat: "Toko makanan sehat.", deskripsi_detail: "Biren cakes adalah toko makanan sehat yang mendapatkan rating sempurna dari pelanggannya. Menyediakan berbagai pilihan kue sehat.", foto_produk: [], kategori: "Toko Makanan Sehat", alamat_lengkap: "Sobangan, Kec. Mengwi, Kabupaten Badung, Denpasar, Bali 80351", jam_operasional: "08:00 - 22:00 WITA", kontak_person: "0877-6146-9066", link_ecommerce: null, iconClass: "fa-map-marker-alt", iconColor: "var(--accent-color)" },
            { id: "umkm11", nama: "Warung Pak Nova", lat: -8.501341275063876, lng: 115.18827080715289, deskripsi_singkat: "Toko kebutuhan sehari-hari.", deskripsi_detail: "Warung Pak Nova menyediakan berbagai kebutuhan pokok dan barang sehari-hari untuk warga sekitar.", foto_produk: [], kategori: "Toko", alamat_lengkap: "Jalan Pejuang No.45, Sobangan, Mengwi, Badung Regency, Bali 80351", jam_operasional: "06:00 - 21:00 WITA", kontak_person: "0851-0388-8632", link_ecommerce: null, iconClass: "fa-map-marker-alt", iconColor: "var(--accent-color)" },
            { id: "umkm12", nama: "Warung Ibu Oki", lat: -8.501702047252756, lng: 115.18833518016598, deskripsi_singkat: "Pusat perbelanjaan dengan rating tinggi.", deskripsi_detail: "Warung Ibu Oki adalah pusat perbelanjaan yang sangat direkomendasikan dengan rating 4.9 dari 10 ulasan.", foto_produk: [], kategori: "Pusat Perbelanjaan", alamat_lengkap: "F5XQ+78W, Sobangan, Kec. Mengwi, Kabupaten Badung, Bali 80351", jam_operasional: "09:00 - 19:50 WITA", kontak_person: "0812-4628-3407", link_ecommerce: null, iconClass: "fa-map-marker-alt", iconColor: "var(--accent-color)" },
            { id: "umkm13", nama: "Warung Bapak Dewa", lat: -8.500067958732323, lng: 115.18881797778377, deskripsi_singkat: "Toko serba ada.", deskripsi_detail: "Warung Bapak Dewa merupakan toko yang menjual berbagai macam barang kebutuhan.", foto_produk: [], kategori: "Toko", alamat_lengkap: "Jalan Pejuang No.45, Sobangan, Mengwi, Badung Regency, Bali 80351", jam_operasional: "07:00 - 20:00 WITA", kontak_person: "0819-9914-6068", link_ecommerce: null, iconClass: "fa-map-marker-alt", iconColor: "var(--accent-color)" },
            { 
        id: "umkm14", 
        nama: "Pengrajin Rindik Suara Githa", 
        lat: -8.502505435742403, 
        lng: 115.19712953056339, 
        deskripsi_singkat: "Asosiasi pengrajin independen alat musik rindik.", 
        deskripsi_detail: "Pengrajin rindik suara githa adalah sebuah asosiasi bagi para pengrajin independen yang berfokus pada pembuatan alat musik tradisional Bali, rindik. Tempat ini menjadi pusat bagi para seniman untuk berkarya dan melestarikan warisan budaya melalui alunan merdu rindik. Mereka menawarkan produk-produk otentik yang dibuat dengan tangan terampil dan bahan-bahan berkualitas.", 
        foto_produk: [], 
        kategori: "Kerajinan Tangan", 
        alamat_lengkap: "Jl. Kapten Japa, Sobangan, Kec. Mengwi, Kabupaten Badung, Bali 80351", 
        jam_operasional: "08:00 - 18:00 WITA", 
        kontak_person: "0812-3609-424", 
        link_ecommerce: null, 
        iconClass: "fa-map-marker-alt", 
        iconColor: "var(--accent-color)" 
    },
    { 
        id: "umkm15", 
        nama: "Kedai Belog Polos", 
        lat: -8.510435941750709, 
        lng: 115.18794096530337, 
        deskripsi_singkat: "Kuliner dengan rating sempurna yang menyajikan hidangan lokal.", 
        deskripsi_detail: "Kedai Belog Polos adalah sebuah kuliner yang berhasil meraih rating sempurna 5.0 dari para pengunjungnya. Tempat ini menawarkan pengalaman kuliner yang otentik dengan berbagai hidangan lezat. Pengunjung dapat menikmati makanan di tempat atau memilih untuk dibawa pulang, menjadikannya pilihan yang fleksibel untuk berbagai kesempatan.", 
        foto_produk: [], 
        kategori: "Kuliner", 
        alamat_lengkap: "Jl. Gunung Agung, Sobangan, Kec. Mengwi, Kabupaten Badung, Bali 80351", 
        jam_operasional: "18:00 - 00:00 WITA", 
        kontak_person: "0878-5591-9222", 
        link_ecommerce: null, 
        iconClass: "fa-map-marker-alt", 
        iconColor: "var(--accent-color)" 
    },
    { 
        id: "umkm16", 
        nama: "Mistake Store", 
        lat: -8.507158511065358, 
        lng: 115.18793992297427, 
        deskripsi_singkat: "Pusat perbelanjaan dan fashion dengan ulasan yang baik.", 
        deskripsi_detail: "Mistake Store adalah sebuah pusat perbelanjaan yang menawarkan berbagai produk fashion dan apparel. Dengan rating 4.3 dari 7 ulasan, toko ini menjadi destinasi populer bagi mereka yang mencari gaya terkini. Mereka juga memiliki kehadiran online melalui blogspot, memungkinkan pelanggan untuk melihat koleksi mereka dari mana saja.", 
        foto_produk: [], 
        kategori: "Pusat Perbelanjaan", 
        alamat_lengkap: "Jl. Gunung Agung No.10, Sobangan, Kec. Mengwi, Kabupaten Badung, Bali 80351", 
        jam_operasional: "10:00 - 22:00 WITA", 
        kontak_person: "0812-4624-8971", 
        link_ecommerce: "mistakeapparel.blogspot.co.id", 
        iconClass: "fa-map-marker-alt", 
        iconColor: "var(--accent-color)" 
    },
    { 
        id: "umkm17", 
        nama: "Kikyobag", 
        lat: -8.50482814702848, 
        lng: 115.18705262106995, 
        deskripsi_singkat: "Toko khusus yang menjual berbagai macam tas.", 
        deskripsi_detail: "Kikyobag adalah toko yang menjual berbagai macam jenis tas. Toko ini menawarkan koleksi tas wanita dengan beragam model dan warna, mulai dari tas tangan hingga tas selempang. Dengan koleksi yang beragam, toko ini menjadi tujuan yang tepat bagi para pecinta fashion yang mencari aksesoris untuk melengkapi penampilan mereka.", 
        foto_produk: [], 
        kategori: "Toko Tas", 
        alamat_lengkap: "Jl. Gunung Agung No.10, Sobangan, Kec. Mengwi, Kabupaten Badung, Bali 80351", 
        jam_operasional: "09:00 - 17:00 WITA", 
        kontak_person: "0821-4564-6430", 
        link_ecommerce: null, 
        iconClass: "fa-map-marker-alt", 
        iconColor: "var(--accent-color)" 
    },
    { 
        id: "umkm18", 
        nama: "Vegetarian hari", 
        lat: -8.503564954056982, 
        lng: 115.18620686655282, 
        deskripsi_singkat: "Kuliner vegetarian dengan rating sempurna.", 
        deskripsi_detail: "Vegetarian hari adalah sebuah kuliner yang menyajikan hidangan khusus vegetarian dan telah mendapatkan rating sempurna 5.0 dari 10 ulasan. Tempat ini menjadi surga bagi para pencari makanan sehat dan lezat tanpa daging. Pelanggan dapat memilih untuk menikmati hidangan mereka di tempat atau membawanya pulang, memberikan kemudahan bagi para pecinta kuliner nabati.", 
        foto_produk: [], 
        kategori: "Kuliner", 
        alamat_lengkap: "Sobangan, Kec. Mengwi, Kabupaten Badung, Bali 80351", 
        jam_operasional: "09:00 - 17:00 WITA", 
        kontak_person: "0822-3653-5889", 
        link_ecommerce: null, 
        iconClass: "fa-map-marker-alt", 
        iconColor: "var(--accent-color)" 
    },
    { 
        id: "umkm19", 
        nama: "Lalapan Nasi Goreng Jawa", 
        lat: -8.503495983264724, 
        lng: 115.18625782852153, 
        deskripsi_singkat: "Kuliner nasi goreng khas Jawa dengan rating sempurna.", 
        deskripsi_detail: "Lalapan Nasi Goreng Jawa adalah Kuliner yang menjual hidangan nasi goreng dengan cita rasa khas Jawa. Meraih rating sempurna 5.0, tempat ini menjadi favorit bagi para penikmat kuliner. Kuliner ini menyediakan opsi makan di tempat dan bawa pulang, cocok untuk makan malam yang memuaskan hingga larut malam.", 
        foto_produk: [],
        kategori: "Kuliner", 
        alamat_lengkap: "F5WP+HGR, Jl. Gunung Agung, Sobangan, Kec. Mengwi, Kabupaten Badung, Bali 80351", 
        jam_operasional: "17:00 - 23:00 WITA", 
        kontak_person: "0822-3536-3086", 
        link_ecommerce: null, 
        iconClass: "fa-map-marker-alt", 
        iconColor: "var(--accent-color)" 
    },
    { 
        id: "umkm20", 
        nama: "MOUREN LAUNDRY", 
        lat: -8.503563627695707, 
        lng: 115.18627459232702, 
        deskripsi_singkat: "Jasa laundry dengan ulasan sempurna.", 
        deskripsi_detail: "MOUREN LAUNDRY adalah penyedia jasa laundry yang mendapatkan kepercayaan penuh dari pelanggannya, terbukti dengan rating 5.0 dari 5 ulasan. Mereka menawarkan solusi praktis untuk kebutuhan mencuci pakaian, memastikan pakaian bersih dan rapi. Layanan mereka yang andal menjadikannya pilihan utama di komunitas sekitar.", 
        foto_produk: [], 
        kategori: "Laundry", 
        alamat_lengkap: "Jl. Gunung Agung No.Br, Dukuh Moncos, Sobangan, Kec. Mengwi, Kabupaten Badung, Bali 80351", 
        jam_operasional: "07:00 - 19:00 WITA", 
        kontak_person: "0813-6168-2019", 
        link_ecommerce: null, 
        iconClass: "fa-map-marker-alt", 
        iconColor: "var(--accent-color)" 
    },
    { 
        id: "umkm21", 
        nama: "TOKO SEDANA HARTA", 
        lat: -8.50189350681066, 
        lng: 115.18849915812815, 
        deskripsi_singkat: "Minimarket yang lengkap dan sangat direkomendasikan.", 
        deskripsi_detail: "TOKO SEDANA HARTA adalah sebuah minimarket yang menyediakan berbagai macam produk kebutuhan sehari-hari. Dengan rating sempurna 5.0 dari 8 ulasan, toko ini dikenal dengan kelengkapan barang dan pelayanannya yang memuaskan. Tempat ini menjadi solusi satu atap bagi warga untuk berbelanja kebutuhan pokok, makanan ringan, hingga minuman.", 
        foto_produk: [], 
        kategori: "Minimarket", 
        alamat_lengkap: "Jl. Pejuang 45, Sobangan, Kec. Mengwi, Kabupaten Badung, Bali 80351", 
        jam_operasional: "24 jam", 
        kontak_person: "0813-3836-7811", 
        link_ecommerce: null, 
        iconClass: "fa-map-marker-alt", 
        iconColor: "var(--accent-color)" 
    },
    { 
        id: "umkm22", 
        nama: "Wr. Bali Suci", 
        lat: -8.499143775808443, 
        lng: 115.19330286312733, 
        deskripsi_singkat: "Pusat perbelanjaan dengan rating sempurna.", 
        deskripsi_detail: "Wr. Bali Suci adalah pusat perbelanjaan yang menawarkan berbagai macam produk, terlihat dari etalase yang penuh dengan aneka makanan ringan dan kebutuhan lainnya. Toko ini berhasil mendapatkan rating 5.0, menunjukkan kepuasan pelanggan yang tinggi terhadap produk dan layanan yang ditawarkan. Buka dari pagi hari, toko ini siap melayani kebutuhan harian para pelanggannya.", 
        foto_produk: [], 
        kategori: "Pusat Perbelanjaan", 
        alamat_lengkap: "Jl. Veteran, Sobangan, Kec. Mengwi, Kabupaten Badung, Bali 80352", 
        jam_operasional: "06:00 - 21:00 WITA", 
        kontak_person: "Tidak tersedia", 
        link_ecommerce: null, 
        iconClass: "fa-map-marker-alt", 
        iconColor: "var(--accent-color)" 
    }
        ];
        
        // --- (Sisa JavaScript tidak berubah) ---
        let map, wisataLayerGroup, umkmLayerGroup, layerControl;
        let featureList, modal, modalTitle, modalBodyContent, spanClose;
        let routingControl = null;
        let userMarker = null;

        // PERBAIKAN: Mengaktifkan GPS asli dari perangkat.
        const USE_REAL_GPS = true; 
        const SIMULATED_CURRENT_LOCATION = { lat: -8.5025, lng: 115.1915 }; // Hanya sebagai fallback jika GPS asli gagal.

        function createCustomLeafletIcon(iconClass, color) {
            return L.divIcon({
                html: `<i class="fas ${iconClass}" style="color: ${color};"></i>`,
                className: 'custom-leaflet-div-icon',
                iconSize: [30, 30], 
                iconAnchor: [15, 30], 
                popupAnchor: [0, -30]  
            });
        }

        function getCurrentLocation(callback) {
            if (USE_REAL_GPS && navigator.geolocation) {
                map.locate({ setView: false, maxZoom: 17, enableHighAccuracy: true });
                map.once('locationfound', function(e) { 
                    callback(e.latlng); 
                });
                map.once('locationerror', function(e) { 
                    alert("Gagal mendapatkan lokasi GPS: " + e.message + "\nPastikan Anda telah mengizinkan akses lokasi di peramban Anda.");
                });
            } else {
                console.log("GPS tidak didukung atau mode simulasi aktif.");
                const simulatedLatLng = L.latLng(SIMULATED_CURRENT_LOCATION.lat, SIMULATED_CURRENT_LOCATION.lng);
                callback(simulatedLatLng);
            }
        }
        
        function handleRouteButtonClick(lat, lng, name) {
            if (modal) {
                modal.style.display = "none";
                document.body.style.overflow = 'auto';
            }
            setupRoutingPanel(lat, lng, name);
        }

        function openModalWithDetails(item, type) {
            if (!modal || !modalTitle || !modalBodyContent) { return; }
            let contentHtml = '';
            let titleIconHtml = ''; 
            const modalIconClass = "fa-map-marker-alt"; 
            
            const routeButtonHtml = `
                <div class="route-button-container">
                    <button class="route-button" onclick="handleRouteButtonClick(${item.lat}, ${item.lng}, '${item.nama.replace(/'/g, "\\'")}')">
                        <i class="fas fa-directions"></i> Dapatkan Rute ke Sini
                    </button>
                </div>
            `;

            if (type === 'wisata') {
                titleIconHtml = `<i class="fas ${modalIconClass}" style="color:${item.iconColor}"></i> ${item.nama}`;
                contentHtml = `
                    <img src="${item.gambar[0]}" alt="${item.nama}" class="main-image" onerror="this.onerror=null;this.src='https://via.placeholder.com/600x280.png?text=Gambar+Tidak+Tersedia';">
                    <h4><i class="fas fa-info-circle"></i> Deskripsi</h4> <p>${item.deskripsi_detail}</p>
                    <h4><i class="fas fa-tags"></i> Kategori</h4> <p>${item.kategori}</p>
                    <h4><i class="fas fa-concierge-bell"></i> Fasilitas</h4> <ul>${item.fasilitas.map(f => `<li><i class="fas fa-check-circle fa-li-icon"></i>${f}</li>`).join('')}</ul>
                    <h4><i class="fas fa-clock"></i> Jam Operasional</h4> <p>${item.jam_operasional}</p>
                    ${routeButtonHtml}`;
            } else if (type === 'umkm') {
    titleIconHtml = `<i class="fas fa-map-marker-alt" style="color:${item.iconColor}"></i> ${item.nama}`;
    contentHtml = `
        <h4><i class="fas fa-info-circle"></i> Deskripsi Produk/Jasa</h4> 
        <p>${item.deskripsi_detail}</p>

        <h4><i class="fas fa-store-alt"></i> Kategori UMKM</h4> 
        <p>${item.kategori}</p>

        <h4><i class="fas fa-map-marker-alt"></i> Alamat</h4> 
        <p>${item.alamat_lengkap}</p>

        <h4><i class="fas fa-clock"></i> Jam Operasional</h4> 
        <p>${item.jam_operasional}</p>

        <h4><i class="fas fa-phone-alt"></i> Kontak</h4> 
        <p>${item.kontak_person || 'Tidak tersedia'}</p>

        ${item.link_ecommerce ? `<h4><i class="fas fa-shopping-cart"></i> Toko Online</h4><p><a href="https://${item.link_ecommerce}" target="_blank" class="contact-link">Kunjungi Toko</a></p>` : ''}
        
        ${routeButtonHtml}`;
}
            modalTitle.innerHTML = titleIconHtml;
            modalBodyContent.innerHTML = contentHtml;
            modal.style.display = "block";
            document.body.style.overflow = 'hidden'; 
        }

        function populateSidebarAndMarkers() {
            if (!featureList || !wisataLayerGroup || !umkmLayerGroup) { return; }
            featureList.innerHTML = ''; 
            wisataLayerGroup.clearLayers(); 
            umkmLayerGroup.clearLayers();   
            
            dataWisata.forEach(item => {
                const marker = L.marker([item.lat, item.lng], { icon: createCustomLeafletIcon(item.iconClass, item.iconColor) });
                marker.on('click', () => openModalWithDetails(item, 'wisata'));
                wisataLayerGroup.addLayer(marker); 
                const listItem = createSidebarItem(item, 'wisata', marker);
                featureList.appendChild(listItem);
            });
            dataUMKM.forEach(item => {
                const marker = L.marker([item.lat, item.lng], { icon: createCustomLeafletIcon(item.iconClass, item.iconColor) });
                marker.on('click', () => openModalWithDetails(item, 'umkm'));
                umkmLayerGroup.addLayer(marker); 
                const listItem = createSidebarItem(item, 'umkm', marker);
                featureList.appendChild(listItem);
            });
            document.getElementById('total-wisata').textContent = dataWisata.length;
            document.getElementById('total-umkm').textContent = dataUMKM.length;
        }
        
        function createSidebarItem(item, type, markerInstance) {
            const listItem = document.createElement('div');
            listItem.className = 'sidebar-item';
            listItem.innerHTML = `
                <i class="fas ${item.iconClass} fa-icon" style="color: ${item.iconColor};"></i> 
                <span class="item-name">${item.nama}</span>
                <span class="item-type">${type === 'wisata' ? 'Wisata' : 'UMKM'} - ${item.kategori}</span>`;
            listItem.onclick = () => {
                map.flyTo([item.lat, item.lng], 16, { animate: true, duration: 1 });
                setTimeout(() => { openModalWithDetails(item, type); }, 600); 
            };
            return listItem;
        }
        
        let layerControlMoved = false;
        function moveLayerControlToSidebarOnce() {
            if (layerControlMoved || !layerControl) return; 
            const filterControlsDiv = document.querySelector('.filter-controls');
            const controlContainer = layerControl.getContainer();
            if (filterControlsDiv && controlContainer) {
                filterControlsDiv.appendChild(controlContainer);
                layerControlMoved = true;
            }
        }

        function initModal() {
            if (!modal || !spanClose) return;
            spanClose.onclick = function() {
                modal.style.display = "none";
                document.body.style.overflow = 'auto';
            }
            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                    document.body.style.overflow = 'auto';
                }
            }
            document.addEventListener('keydown', function(event) {
                if (event.key === "Escape" && modal.style.display === "block") {
                    modal.style.display = "none";
                    document.body.style.overflow = 'auto';
                }
            });
        }
        
        function addCustomRoutingUI(routingControl) {
            const container = routingControl.getContainer();
            if (!container) return;

            let existingSuggestions = container.querySelector('.routing-suggestions-container');
            if (existingSuggestions) { existingSuggestions.remove(); }

            const suggestionsContainer = L.DomUtil.create('div', 'routing-suggestions-container');
            
            const yourLocationItem = L.DomUtil.create('div', 'routing-suggestion-item', suggestionsContainer);
            yourLocationItem.innerHTML = `
                <div class="suggestion-icon"><i class="fas fa-location-crosshairs"></i></div>
                <span class="suggestion-text">Lokasi Anda</span>
            `;

            L.DomEvent.on(yourLocationItem, 'click', function() {
                getCurrentLocation(function(latlng) {
                    routingControl.spliceWaypoints(0, 1, { latLng: latlng, name: 'Lokasi Anda' });
                    map.panTo(latlng);
                });
            });

            const geocodersContainer = container.querySelector('.leaflet-routing-geocoders');
            if (geocodersContainer) {
                geocodersContainer.parentNode.insertBefore(suggestionsContainer, geocodersContainer.nextSibling);
            }

            const swapButton = container.querySelector('.leaflet-routing-add-waypoint');
            if (swapButton) {
                L.DomEvent.on(swapButton, 'click', function() {
                    const waypoints = routingControl.getWaypoints();
                    routingControl.setWaypoints(waypoints.reverse());
                });
            }
        }

        function setupRoutingPanel(destinationLat, destinationLng, destinationName) {
            if (routingControl != null) {
                map.removeControl(routingControl);
                routingControl = null;
            }

            routingControl = L.Routing.control({
                waypoints: [
                    null,
                    L.Routing.waypoint(L.latLng(destinationLat, destinationLng), destinationName)
                ],
                geocoder: L.Control.Geocoder.nominatim(),
                show: true, 
                addWaypoints: true,
                routeWhileDragging: true,
                fitSelectedRoutes: 'smart',
                geocoderPlaceholder: function(i, n) {
                    return i === 0 ? 'Pilih titik awal, atau klik peta...' : 'Pilih tujuan...';
                },
                lineOptions: {
                    styles: [{ color: 'var(--primary-color)', opacity: 0.8, weight: 6 }]
                },
                createMarker: function(i, waypoint, n) {
                    if (!waypoint.latLng) return null;
                    const icon = createCustomLeafletIcon(i === 0 ? 'fa-location-arrow' : 'fa-map-marker-alt', i === 0 ? 'green' : 'var(--primary-color)');
                    return L.marker(waypoint.latLng, { draggable: true, icon: icon });
                }
            }).addTo(map);

            addCustomRoutingUI(routingControl);
            
            routingControl.on('routingstart', function(e) {
                const container = this.getContainer();
                if(container) {
                    const itinerary = container.querySelector('.leaflet-routing-itinerary-container');
                    const suggestions = container.querySelector('.routing-suggestions-container');
                    if (itinerary) itinerary.style.display = 'none';
                    if (suggestions) suggestions.style.display = 'block';
                }
            });

            routingControl.on('routesfound', function(e) {
                const container = this.getContainer();
                if(container) {
                    const itinerary = container.querySelector('.leaflet-routing-itinerary-container');
                    const suggestions = container.querySelector('.routing-suggestions-container');
                    if (itinerary) itinerary.style.display = 'block';
                    if (suggestions) suggestions.style.display = 'none';
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            featureList = document.getElementById('feature-list');
            modal = document.getElementById('infoModal');
            modalTitle = document.getElementById('modalTitle');
            modalBodyContent = document.getElementById('modalBodyContent');
            spanClose = document.getElementsByClassName("close-button")[0];

            if (!featureList || !modal || !modalTitle || !modalBodyContent || !spanClose) {
                console.error("Satu atau lebih elemen DOM penting tidak ditemukan.");
                return; 
            }
            initModal(); 

            const disclaimerModal = document.getElementById('disclaimerModal');
            const disclaimerCloseBtn = document.getElementById('disclaimerCloseBtn');

            if (!sessionStorage.getItem('disclaimerAccepted')) {
                disclaimerModal.style.display = 'flex';
                document.body.style.overflow = 'hidden'; 
            }

            disclaimerCloseBtn.onclick = function() {
                disclaimerModal.style.display = 'none';
                sessionStorage.setItem('disclaimerAccepted', 'true'); 
                document.body.style.overflow = 'auto'; 
            }

            map = L.map('map', { zoomControl: false }).setView(initialCoords, 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors & OSRM'
            }).addTo(map);

            const toggleBtn = document.getElementById('toggle-sidebar-btn');
            const sidebar = document.getElementById('sidebar');

            if (toggleBtn && sidebar) {
                toggleBtn.addEventListener('click', () => {
                    sidebar.classList.toggle('closed');
                    // Beri tahu peta untuk menyesuaikan ukurannya setelah animasi selesai
                    setTimeout(() => {
                        if (map) {
                            map.invalidateSize();
                        }
                    }, 300); // Sesuaikan dengan durasi transisi CSS
                });
            }

            wisataLayerGroup = L.layerGroup().addTo(map); 
            umkmLayerGroup = L.layerGroup().addTo(map);   

            L.control.zoom({ position: 'topleft' }).addTo(map);
            L.Control.geocoder({
                defaultMarkGeocode: false, placeholder: 'Cari alamat atau tempat...', position: 'topleft', 
                geocoder: L.Control.Geocoder.nominatim(), collapsed: true, iconLabel: '' 
            })
            .on('markgeocode', function(e) {
                var b = e.geocode.bbox; map.fitBounds(L.polygon([b.getSouthEast(),b.getNorthEast(),b.getNorthWest(),b.getSouthWest()]).getBounds());
            })
            .addTo(map);

            const locateButton = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
            const locateLink = L.DomUtil.create('a', 'leaflet-control-locate', locateButton);
            locateLink.href = '#'; locateLink.title = 'Lokasi Saya';
            locateLink.innerHTML = '<i class="fas fa-street-view"></i>'; 
            
            L.DomEvent.on(locateLink, 'click', function(ev) { 
                L.DomEvent.stop(ev); 
                if (routingControl != null) {
                    map.removeControl(routingControl);
                    routingControl = null;
                }
                getCurrentLocation(function(latlng) {
                    map.flyTo(latlng, 17);
                    if (userMarker) {
                        map.removeLayer(userMarker);
                    }
                    userMarker = L.marker(latlng, { icon: createCustomLeafletIcon('fa-person-hiking', 'red') })
                        .addTo(map)
                        .bindPopup(`<b>Lokasi Anda</b>`)
                        .openPopup();
                });
            });
            const LocateControl = L.Control.extend({ onAdd: function(map) { return locateButton; } });
            new LocateControl({ position: 'topleft' }).addTo(map);

            L.Control.ResetView = L.Control.extend({
                onAdd: function(map) {
                    var c = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                    c.innerHTML = '<a href="#" title="Kembali ke Tampilan Awal"><i class="fas fa-home"></i></a>';
                    c.style.backgroundColor = 'white';
                    L.DomEvent.on(c, 'click', function (e) { 
                        L.DomEvent.stop(e); 
                        L.DomEvent.preventDefault(e); 
                        if (routingControl != null) {
                            map.removeControl(routingControl);
                            routingControl = null;
                        }
                        if (userMarker) {
                            map.removeLayer(userMarker);
                            userMarker = null;
                        }
                        map.setView(initialCoords, 15); 
                    });
                    return c;
                }
            });
            L.control.resetView = function(opts) { return new L.Control.ResetView(opts); }
            L.control.resetView({ position: 'topleft' }).addTo(map);
            
            L.control.scale({ imperial: false, position: 'bottomleft' }).addTo(map);

            const overlayMaps = {
                "<i class='fas fa-map-marker-alt' style='color:var(--secondary-color)'></i> Destinasi Wisata": wisataLayerGroup,
                "<i class='fas fa-map-marker-alt' style='color:var(--accent-color)'></i> UMKM Lokal": umkmLayerGroup
            };
            layerControl = L.control.layers(null, overlayMaps, { collapsed: false });
            layerControl.addTo(map); 

            map.whenReady(function() {
                moveLayerControlToSidebarOnce();
                populateSidebarAndMarkers(); 
            });
        });
        
    </script>
</body>
</html>