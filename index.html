<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoExplore Sobangan</title>

    <!-- Google Fonts: Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin="" />

    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
        integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Leaflet Control Geocoder CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    
    <style>
        :root {
            /* Warna Tema */
            --primary-color: #086cfc; 
            --primary-color-darker: #0759d3; 
            --primary-font-color: #ffffff; 
            
            --secondary-color: #10B981; 
            --accent-color: #F59E0B; 
            
            --light-gray: #F3F4F6;
            --medium-gray: #D1D5DB;
            --dark-gray: #4B5563; 
            --text-color: #3a2e27; 
            --font-main: 'Poppins', sans-serif;
        }

        body {
            font-family: var(--font-main);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: var(--light-gray);
            color: var(--text-color);
            font-size: 15px; 
        }

        header {
            position: relative; /* Ini penting agar tombol bisa diposisikan di dalamnya */
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--primary-color-darker) 100%);
            color: var(--primary-font-color); 
            padding: 15px 50px; /* Beri ruang untuk tombol di kiri */
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1002; 
        }

        header h1 {
            margin: 0;
            font-size: 1.5em; 
            font-weight: 600;
        }
         header h1 i {
            margin-right: 8px;
            font-size: 0.9em; 
        }

        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        #sidebar {
            width: 320px; 
            background-color: #ffffff;
            padding: 18px;
            overflow-y: auto;
            box-shadow: 2px 0 6px rgba(0,0,0,0.08);
            transition: width 0.3s ease;
            border-right: 1px solid var(--medium-gray);
            z-index: 1001;
            display: flex;
            flex-direction: column;
        }
        
        #sidebar h2 {
            margin-top: 0;
            color: var(--primary-color); 
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            font-size: 1.25em; 
            display: flex;
            align-items: center;
            font-weight: 600;
        }
         #sidebar h2 i {
            margin-right: 8px;
            font-size: 0.9em;
        }
        h2.section-title-lokasi {
            margin-top: 20px !important; 
        }

        .dashboard-stats {
            background-color: var(--light-gray);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 18px;
            border: 1px solid var(--medium-gray);
        }
        .dashboard-stats h3 {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 1.05em; 
            color: var(--dark-gray);
            font-weight: 500;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 7px 0;
            font-size: 0.9em; 
            border-bottom: 1px dashed var(--medium-gray);
        }
        .stat-item:last-child {
            border-bottom: none;
        }
        .stat-item .label {
            color: var(--dark-gray);
            display: flex;
            align-items: center;
        }
        .stat-item .label i {
            margin-right: 6px;
            font-size: 1em; 
        }
        .stat-item .value {
            font-weight: 600;
            color: var(--primary-color); 
        }
        
        .filter-controls {
            margin-bottom: 10px; 
            padding: 10px;
            background-color: var(--light-gray);
            border-radius: 6px;
            border: 1px solid var(--medium-gray);
            overflow: auto; 
        }
        .filter-controls h3 {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 1.05em; 
            color: var(--dark-gray);
            font-weight: 500;
        }
        .filter-controls .leaflet-control-layers {
            position: relative !important;
            float: none !important;
            clear: both !important;
            width: auto !important; 
            margin-top: 5px !important;
            box-shadow: none !important;
            border: none !important;
            background-color: transparent !important; 
            padding: 0 !important;
        }
        .filter-controls .leaflet-control-layers-overlays label {
            font-size: 0.9em;
            display: flex; 
            align-items: center;
            padding: 3px 0; 
            color: var(--text-color); 
        }
        .filter-controls .leaflet-control-layers-overlays input[type="checkbox"] {
            margin-right: 8px; 
            accent-color: var(--primary-color); 
        }
        .filter-controls .leaflet-control-layers-overlays label i {
             margin-right: 5px;
             font-size: 1em;
         }

        #feature-list {
            flex-grow: 1; /* Allow list to grow */
        }
        .sidebar-item {
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 1px solid var(--medium-gray);
            background-color: #fff;
        }

        .sidebar-item:hover {
            background-color: #f7fcff; 
            border-color: var(--primary-color);
            transform: translateX(3px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.04);
        }

        .sidebar-item i.fa-icon { 
            margin-right: 8px;
            font-size: 1em; 
            width: 18px; 
            text-align: center;
        }
        
        .sidebar-item .item-name {
            font-weight: 500;
            font-size: 0.95em; 
        }

        .sidebar-item .item-type {
            font-size: 0.75em; 
            color: #6B7280; 
            display: block;
            margin-top: 2px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .credits {
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid var(--light-gray);
            text-align: center;
            font-size: 0.8em;
            color: var(--dark-gray);
        }
        .credits p {
            margin: 0;
            line-height: 1.5;
        }
        .credits strong {
            color: var(--text-color);
            font-weight: 600;
        }

        #map {
            flex-grow: 1;
            height: 100%;
            z-index: 0;
        }

        .custom-leaflet-div-icon {
            background: transparent;
            border: none;
        }
        .custom-leaflet-div-icon i.fa-map-marker-alt,
        .custom-leaflet-div-icon i.fa-location-arrow,
        .custom-leaflet-div-icon i.fa-person-hiking { 
            font-size: 30px; 
            text-shadow: 1px 1px 3px rgba(0,0,0,0.4);
        }

        .modal {
            display: none; 
            position: fixed; 
            z-index: 1003; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.65); 
            padding-top: 20px; 
        }

        #disclaimerModal {
            z-index: 1005; 
            display: none; 
            align-items: center;
            justify-content: center;
            padding: 15px;
        }

        #disclaimerModal .modal-content {
            margin: 0;
            animation: fadeInModal 0.4s ease-out;
            max-width: 550px;
        }

        #disclaimerModal .modal-body {
            max-height: none;
            padding-right: 0;
        }

        .disclaimer-footer {
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid var(--light-gray);
            text-align: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 3% auto; 
            padding: 20px 25px;
            border: none; 
            width: 90%; 
            max-width: 650px; 
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.25);
            position: relative;
            animation: fadeInModal 0.3s ease-out;
        }

        @keyframes fadeInModal {
            from { opacity: 0; transform: translateY(-15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .close-button {
            color: #9CA3AF;
            float: right;
            font-size: 24px; 
            font-weight: bold;
            position: absolute;
            top: 12px;
            right: 18px;
            transition: color 0.2s;
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--text-color);
            text-decoration: none;
            cursor: pointer;
        }

        .modal-header h2 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--primary-color); 
            font-size: 1.6em; 
            font-weight: 600;
        }
         .modal-header h2 i {
            margin-right: 10px;
            font-size: 0.9em; 
         }

        .modal-body {
            margin-top: 15px;
            max-height: 65vh;
            overflow-y: auto;
            padding-right: 10px; 
        }
        .modal-body img.main-image {
            width: 100%;
            max-height: 280px; 
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 12px;
            border: 1px solid var(--medium-gray);
        }
        .modal-body h4 {
            color: var(--dark-gray);
            margin-top: 12px;
            margin-bottom: 4px;
            font-size: 1em; 
            font-weight: 600;
        }
         .modal-body h4 i {
            margin-right: 6px;
            font-size: 0.9em;
         }
        .modal-body p, .modal-body ul {
            line-height: 1.6;
            font-size: 0.9rem; 
            margin-bottom: 8px;
        }
        .modal-body ul {
            list-style: none;
            padding-left: 0;
        }
        .modal-body ul li {
            padding: 4px 0;
            border-bottom: 1px dashed var(--medium-gray);
            display: flex;
            align-items: center;
        }
         .modal-body ul li:last-child {
            border-bottom: none;
         }
        .modal-body ul li i.fa-li-icon { 
            margin-right: 8px;
            color: var(--secondary-color);
            width: 18px; 
            font-size: 0.9em;
        }
        .modal-body .contact-link {
            color: var(--primary-color); 
            text-decoration: none;
            font-weight: 500;
        }
        .modal-body .contact-link:hover {
            text-decoration: underline;
        }
        
        .modal-body::-webkit-scrollbar { width: 6px; }
        .modal-body::-webkit-scrollbar-track { background: var(--light-gray); border-radius: 10px; }
        .modal-body::-webkit-scrollbar-thumb { background: var(--medium-gray); border-radius: 10px; }
        .modal-body::-webkit-scrollbar-thumb:hover { background: var(--dark-gray); }

        .route-button-container {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--medium-gray);
        }
        .route-button {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 18px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.95em;
            font-family: var(--font-main);
            font-weight: 500;
            transition: background-color 0.2s ease;
            width: 100%; 
        }
        .route-button:hover {
            background-color: var(--primary-color-darker);
        }
        .route-button i {
            margin-right: 8px;
        }

        .leaflet-routing-container {
            background-color: white;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            font-family: var(--font-main);
        }

        .leaflet-routing-geocoder input {
            border: 1px solid var(--medium-gray) !important;
            padding: 10px 12px !important; 
            width: 100% !important;
            box-sizing: border-box;
            transition: border-color 0.2s;
            border-radius: 6px !important;
            font-family: var(--font-main);
            font-size: 14px;
        }

        #toggle-sidebar-btn {
            position: absolute;
            top: 50%;
            left: 15px;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--primary-font-color);
            font-size: 1.4em;
            cursor: pointer;
            z-index: 1003;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        #toggle-sidebar-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        #sidebar.closed {
            width: 0;
            padding-left: 0;
            padding-right: 0;
            overflow: hidden;
            border-right: none;
        }

        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--dark-gray);
            font-size: 0.9em;
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--medium-gray);
            border-radius: 4px;
            font-family: var(--font-main);
            font-size: 0.9em;
            box-sizing: border-box;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(8, 108, 252, 0.15);
        }
        .form-group small {
            font-size: 0.8em;
            color: var(--dark-gray);
        }
        .form-actions {
            margin-top: 20px;
            text-align: right;
        }
        .specific-fields {
            display: none;
            border-left: 3px solid var(--accent-color);
            padding-left: 15px;
            margin-top: 15px;
        }
        
        .leaflet-bar a, .leaflet-bar a:hover {
            width: 30px !important;
            height: 30px !important;
            line-height: 30px !important;
        }
        .leaflet-bar a i { 
             color: var(--primary-color);
        }
        .leaflet-bar a:hover i {
            color: var(--primary-color-darker);
        }

        @media (max-width: 768px) {
            body {
                height: auto;
                display: block;
            }
            .container {
                flex-direction: column;
                height: auto;
                overflow: visible;
            }
            #sidebar {
                width: 100%;
                max-height: 50vh; 
                box-sizing: border-box; 
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                border-right: none;
                border-bottom: 1px solid var(--medium-gray);
                padding: 15px;
            }
            #toggle-sidebar-btn {
                display: none;
            }
            #map {
                height: 60vh; 
                flex-grow: 0;
            }
            .modal-content {
                width: 95%;
                margin: 5% auto;
                padding: 15px 20px;
            }
            .modal-header h2 {
                font-size: 1.4em;
            }
            .modal-body {
                max-height: 70vh;
            }
             #disclaimerModal .modal-content {
                width: 95%;
                margin: auto;
            }
        }
    </style>
</head>
<body>

    <header>
        <button id="toggle-sidebar-btn" title="Buka/Tutup Dashboard">
            <i class="fas fa-bars"></i>
        </button>
        <h1><i class="fas fa-map-signs"></i> WebGIS Desa Sobangan: Eksplorasi Destinasi Wisata dan UMKM Lokal</h1>
    </header>

    <div class="container">
        <div id="sidebar">
            <div>
                <h2><i class="fas fa-tachometer-alt"></i> Dashboard</h2>
                <div class="dashboard-stats">
                    <h3><i class="fas fa-chart-pie"></i> Statistik</h3>
                    <div class="stat-item">
                        <span class="label"><i class="fas fa-map-marker-alt" style="color: var(--secondary-color);"></i> Total Wisata</span>
                        <span class="value" id="total-wisata">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="label"><i class="fas fa-map-marker-alt" style="color: var(--accent-color);"></i> Total UMKM</span>
                        <span class="value" id="total-umkm">0</span>
                    </div>
                </div>

                <div class="filter-controls">
                    <h3><i class="fas fa-filter"></i> Filter Tampilan</h3>
                </div>

                <h2 class="section-title-lokasi"><i class="fas fa-list-ul"></i> Daftar Lokasi</h2>
                <button id="addDataBtn" class="route-button" style="width:100%; margin-bottom:10px;"><i class="fas fa-plus-circle"></i> Tambah Data Baru</button>

                <div id="feature-list">
                    <!-- Items populated by JavaScript -->
                </div>
            </div>

            <div class="credits">
                <p>Dibuat oleh: <br>
                <strong>Maureen Arsa Sanda Cantika</strong><br>
                Sistem Informasi Geografis<br>
                KKN PPM UGM Gantari Mengwi 2025</p>
            </div>
        </div>
        <div id="map"></div>
    </div>

    <div id="infoModal" class="modal">
        <div class="modal-content">
            <span class="close-button">×</span>
            <div class="modal-header">
                <h2 id="modalTitle"><i class="fas fa-info-circle"></i> Detail Informasi</h2>
            </div>
            <div class="modal-body" id="modalBodyContent">
                <!-- Content populated by JavaScript -->
            </div>
        </div>
    </div>

    <div id="disclaimerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-exclamation-triangle"></i> Disclaimer</h2>
            </div>
            <div class="modal-body">
                <p>Selamat datang di WebGIS Desa Sobangan.</p>
                <p>Data dan informasi yang tersedia dalam halaman ini, termasuk lokasi, deskripsi, dan foto, disusun sebagai layanan informasi publik untuk mempromosikan potensi wisata dan UMKM di Desa Sobangan.</p>
                <p>Meskipun kami berusaha menyajikan data seakurat mungkin, tidak ada jaminan semua informasi 100% akurat atau terkini. Pengguna disarankan melakukan verifikasi mandiri.</p>
                <p><b>Dengan menekan tombol di bawah, Anda dianggap memahami dan menerima ketentuan ini.</b></p>
                <div class="disclaimer-footer">
                     <button id="disclaimerCloseBtn" class="route-button" style="width: auto; padding: 10px 25px;">Saya Mengerti & Lanjutkan</button>
                </div>
            </div>
        </div>
    </div>

    <div id="crudModal" class="modal">
        <div class="modal-content">
            <span class="close-button crud-close-button">×</span>
            <div class="modal-header">
                <h2 id="crudModalTitle"><i class="fas fa-edit"></i> Kelola Data Lokasi</h2>
            </div>
            <div class="modal-body" id="crudModalBody">
                <form id="crudForm">
                    <input type="hidden" id="crudItemId">
                    <div class="form-group">
                        <label for="crudItemType">Tipe Data:</label>
                        <select id="crudItemType" required>
                            <option value="wisata">Destinasi Wisata</option>
                            <option value="umkm">UMKM</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="crudNama">Nama Lokasi:</label>
                        <input type="text" id="crudNama" required>
                    </div>
                    <div class="form-group">
                        <label for="crudLat">Latitude:</label>
                        <input type="number" step="any" id="crudLat" required>
                    </div>
                    <div class="form-group">
                        <label for="crudLng">Longitude:</label>
                        <input type="number" step="any" id="crudLng" required>
                         <small><i>Klik lokasi pada peta untuk mengisi Latitude & Longitude secara otomatis.</i></small>
                    </div>
                    <div class="form-group">
                        <label for="crudDeskripsi">Deskripsi Detail:</label>
                        <textarea id="crudDeskripsi" rows="4" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="crudKategori">Kategori:</label>
                        <input type="text" id="crudKategori" required>
                    </div>
                    <div class="form-group">
                        <label for="crudFasilitas">Fasilitas:</label>
                        <textarea id="crudFasilitas" rows="2"></textarea>
                        <small><i>Pisahkan setiap fasilitas dengan koma (contoh: Toilet, Parkir, WiFi).</i></small>
                    </div>
                    <div class="form-group">
                        <label for="crudJamOperasional">Jam Operasional:</label>
                        <input type="text" id="crudJamOperasional" placeholder="Contoh: 08:00 - 17:00 WITA">
                    </div>
                    <div id="umkmFields" class="specific-fields">
                         <div class="form-group">
                            <label for="crudAlamat">Alamat Lengkap:</label>
                            <input type="text" id="crudAlamat">
                        </div>
                         <div class="form-group">
                            <label for="crudKontak">Kontak Person:</label>
                            <input type="text" id="crudKontak">
                        </div>
                    </div>
                    <div class="form-actions">
                         <button type="submit" class="route-button">Simpan Data</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- SCRIPT SECTION -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    
    <script>
    // --- GLOBAL VARIABLES & CONSTANTS ---
    const initialCoords = [-8.502, 115.192];
    const initialZoom = 15;
    let dataWisata = [];
    let dataUMKM = [];
    let map, wisataLayerGroup, umkmLayerGroup, layerControl;
    let featureList, modal, modalTitle, modalBodyContent;
    let routingControl = null;
    let userMarker = null;

    // Initial data (only loaded if local storage is empty)
    const initialDataWisata = [
         { id: "wisata3", nama: "Tugu Pahlawan Kapten Tjok. Agung Tresna", lat: -8.497394, lng: 115.195481, deskripsi_singkat: "Monumen untuk mengenang jasa pahlawan.", deskripsi_detail: "Tugu Pahlawan Kapten Tjok. Agung Tresna merupakan sebuah monumen bersejarah yang berdiri kokoh di Desa Sobangan sebagai wujud penghormatan abadi atas jasa dan pengorbanan heroik Kapten Anumerta Tjokorda Agung Tresna. Lokasi ini memiliki makna yang mendalam, karena Desa Sobangan pernah menjadi Markas Besar Pandawa, pusat komando perjuangan gerilya yang dipimpin oleh Kapten Tjok. Agung Tresna melawan tentara NICA. Dibangun atas inisiatif dan swadaya masyarakat setempat sekitar tahun 1953, pendirian tugu ini juga dilandasi oleh sebuah keyakinan spiritual setelah munculnya pertanda gaib yang diyakini sebagai keinginan arwah sang pahlawan untuk diabadikan di tanah tempat ia berjuang bersama rakyat yang setia. Lebih dari sekadar penanda fisik, monumen ini adalah simbol ikatan batin yang kuat antara seorang pahlawan dengan masyarakatnya, serta menjadi pengingat sejarah perjuangan kemerdekaan bagi seluruh generasi di Desa Sobangan.", gambar: ["./tugu_pahlawan.jpeg"], kategori: "Monumen & Sejarah", fasilitas: ["Area Terbuka", "Akses Umum"], jam_operasional: "Terbuka 24 Jam", iconClass: "fa-map-marker-alt", iconColor: "var(--secondary-color)" },
         { id: "wisata4", nama: "Lapangan Umum Kapten Tjok. Agung Tresna", lat: -8.497291, lng: 115.195171, deskripsi_singkat: "Fasilitas olahraga dan ruang terbuka hijau.", deskripsi_detail: "Mengabadikan nama dan semangat sang pahlawan, Lapangan Umum Kapten Tjok. Agung Tresna merupakan jantung dari kehidupan sosial dan olahraga bagi masyarakat Desa Sobangan. Hamparan rumput hijau yang terawat ini tidak pernah sepi dari aktivitas, mulai dari riuh oleh sorak-sorai anak-anak dan pemuda yang berlatih sepak bola setiap sore, hingga menjadi lokasi utama untuk berbagai perayaan desa, upacara, dan kegiatan rekreasi bersama. Lebih dari sekadar fasilitas olahraga, lapangan ini adalah ruang terbuka tempat terjalinnya kebersamaan, tumbuhnya bibit-bibit atlet lokal, dan dilestarikannya semangat komunal yang menjadi ciri khas warga Desa Sobangan.", gambar: ["./lapangan_bolaumum.jpeg"], kategori: "Olahraga & Rekreasi", fasilitas: ["Lapangan Bola", "Area Terbuka"], jam_operasional: "Terbuka untuk umum", iconClass: "fa-map-marker-alt", iconColor: "var(--secondary-color)" },
         { id: "wisata5", nama: "Uma Pacung Jogging Track", lat: -8.484339, lng: 115.187119, deskripsi_singkat: "Jalur lari di sekitar area persawahan.", deskripsi_detail: "Uma Pacung Jogging Track adalah sebuah oase hijau yang menawarkan pengalaman rekreasi unik di tengah lanskap agraris Desa Sobangan. Jalur aspal mulus ini membentang, mengelilingi kawasan vital Balai Penyuluhan Pertanian (BPP) Mengwi, menjadikannya etalase hidup dari kekayaan pertanian lokal. Sambil berolahraga, pengunjung disuguhi pemandangan sawah berundak yang luas dan asri, dengan warna hijau atau kuning keemasan tergantung pada musim panen. Suasana tenang pedesaan, ditemani semilir angin sejuk dan lambaian pohon kelapa, menjadikan tempat ini lokasi yang sempurna untuk jogging, bersepeda, atau sekadar berjalan santai di pagi dan sore hari. Jalur ini bukan hanya fasilitas olahraga, tetapi juga ruang interaksi dengan alam dan kehidupan petani, memberikan kesempatan untuk melepaskan penat sambil menikmati keindahan otentik pedesaan Bali.", gambar: ["./joggingtrack_kantor_bpp_mengwi.jpeg"], kategori: "Olahraga & Rekreasi", fasilitas: ["Jalur Lari", "Pemandangan Sawah"], jam_operasional: "Terbuka untuk umum", iconClass: "fa-map-marker-alt", iconColor: "var(--secondary-color)" },
         { id: "wisata6", nama: "Jogging Track Munduk Babakan Sobangan", lat: -8.503550, lng: 115.193199, deskripsi_singkat: "Jalur lari dengan pemandangan alam perbukitan.", deskripsi_detail: "Jogging Track Munduk Babakan Sobangan adalah sebuah jalur tersembunyi yang menawarkan pengalaman lari dan berjalan kaki yang benar-benar menyatu dengan alam. Berlokasi di area perbukitan Munduk Babakan yang sejuk, jalur beton ini berkelok-kelok, membelah hamparan mozaik perkebunan subur yang terdiri dari sawah, tanaman palawija, dan dikelilingi oleh rimbunnya pepohonan kelapa. Tempat ini adalah pilihan ideal untuk memulai hari dengan olahraga pagi atau bersantai di sore hari, sambil menghirup udara bersih perbukitan dan menikmati ketenangan pedesaan yang otentik. Jauh dari kebisingan, jalur ini tidak hanya menyehatkan tubuh, tetapi juga menenangkan jiwa dengan pemandangan hijau khas Sobangan yang memanjakan mata.", gambar: ["./munduk_babakan_sobangan_jogging_track.jpeg"], kategori: "Olahraga & Rekreasi", fasilitas: ["Jalur Lari", "Pemandangan Alam", "Area Terbuka"], jam_operasional: "Terbuka untuk umum", iconClass: "fa-map-marker-alt", iconColor: "var(--secondary-color)" }
    ];
    const initialDataUMKM = [
        { id: "umkm3", nama: "Nang Kisnong Garden", lat: -8.490338522730275, lng: 115.194062022974, deskripsi_singkat: "Pusat bibit tanaman dan perlengkapan berkebun.", deskripsi_detail: "Nang Kisnong Garden menyediakan berbagai macam bibit tanaman hias, pot dalam berbagai ukuran dan bahan, serta media tanam berkualitas. Cocok bagi para penggemar berkebun untuk melengkapi koleksi atau memulai taman baru.", foto_produk: [], kategori: "Perlengkapan Taman", alamat_lengkap: "Sobangan, Kec. Mengwi, Kabupaten Badung, Bali 80351", jam_operasional: "08:00 - 18:00 WITA", kontak_person: "Tidak tersedia", link_ecommerce: null, iconClass: "fa-map-marker-alt", iconColor: "var(--accent-color)", fasilitas: ["Toko Fisik", "Area Parkir"] },
        { id: "umkm4", nama: "Raya Koi Bali", lat: -8.491896060727917, lng: 115.18791726834016, deskripsi_singkat: "Toko khusus ikan hias Koi.", deskripsi_detail: "Toko ikan hias yang khusus menjual berbagai jenis ikan Koi berkualitas. Menyediakan juga pakan dan perlengkapan akuarium untuk para penghobi ikan.", foto_produk: [], kategori: "Toko Ikan Hias", alamat_lengkap: "Jl. Surapati, Sobangan, Kec. Mengwi, Kabupaten Badung, Bali 08351", jam_operasional: "07:00 - 22:00 WITA", kontak_person: "Tidak tersedia", link_ecommerce: null, iconClass: "fa-map-marker-alt", iconColor: "var(--accent-color)", fasilitas: ["Toko Fisik"] },
        { id: "umkm5", nama: "Warung Tipat Cantok 'Ming Bonie'", lat: -8.491428866108134, lng: 115.19432333461874, deskripsi_singkat: "Warung makanan khas Bali, tipat cantok.", deskripsi_detail: "Warung sederhana yang menyajikan tipat cantok, makanan khas Bali dengan bumbu kacang yang lezat. Pilihan populer untuk makan siang atau malam bagi warga sekitar.", foto_produk: [], kategori: "Kuliner", alamat_lengkap: "Sobangan, Kec. Mengwi, Kabupaten Badung, Bali 80351", jam_operasional: "09:00 - 23:00 WITA", kontak_person: "087883985096", link_ecommerce: null, iconClass: "fa-map-marker-alt", iconColor: "var(--accent-color)", fasilitas: ["Makan di Tempat", "Bawa Pulang"] }
    ];
        
    // --- DATA HANDLING (CRUD) FUNCTIONS ---
    function saveDataToLocalStorage() {
        localStorage.setItem('dataWisata', JSON.stringify(dataWisata));
        localStorage.setItem('dataUMKM', JSON.stringify(dataUMKM));
    }

    function loadDataFromLocalStorage() {
        const storedWisata = localStorage.getItem('dataWisata');
        const storedUMKM = localStorage.getItem('dataUMKM');
        if (storedWisata && storedUMKM) {
            dataWisata = JSON.parse(storedWisata);
            dataUMKM = JSON.parse(storedUMKM);
        } else {
            dataWisata = initialDataWisata;
            dataUMKM = initialDataUMKM;
            saveDataToLocalStorage();
        }
    }

    function showAddForm() {
        document.getElementById('crudForm').reset();
        document.getElementById('crudItemId').value = '';
        document.getElementById('crudModalTitle').innerHTML = '<i class="fas fa-plus-circle"></i> Tambah Data Baru';
        document.getElementById('crudModal').style.display = 'block';
        toggleUMKMFields();
    }

    function showEditForm(id, type) {
        const dataArray = type === 'wisata' ? dataWisata : dataUMKM;
        const item = dataArray.find(d => d.id === id);
        if (!item) return;

        document.getElementById('infoModal').style.display = 'none';
        document.getElementById('crudItemId').value = item.id;
        document.getElementById('crudItemType').value = type;
        document.getElementById('crudNama').value = item.nama;
        document.getElementById('crudLat').value = item.lat;
        document.getElementById('crudLng').value = item.lng;
        document.getElementById('crudDeskripsi').value = item.deskripsi_detail;
        document.getElementById('crudKategori').value = item.kategori;
        document.getElementById('crudJamOperasional').value = item.jam_operasional || '';
        document.getElementById('crudFasilitas').value = Array.isArray(item.fasilitas) ? item.fasilitas.join(', ') : '';
        if (type === 'umkm') {
             document.getElementById('crudAlamat').value = item.alamat_lengkap || '';
             document.getElementById('crudKontak').value = item.kontak_person || '';
        }
        toggleUMKMFields();
        document.getElementById('crudModalTitle').innerHTML = '<i class="fas fa-edit"></i> Edit Data Lokasi';
        document.getElementById('crudModal').style.display = 'block';
    }

    function handleDeleteItem(id, type) {
        if (!confirm('Apakah Anda yakin ingin menghapus data ini? Aksi ini tidak dapat dibatalkan.')) { return; }
        if (type === 'wisata') {
            dataWisata = dataWisata.filter(item => item.id !== id);
        } else {
            dataUMKM = dataUMKM.filter(item => item.id !== id);
        }
        saveDataToLocalStorage();
        populateSidebarAndMarkers();
        document.getElementById('infoModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    function toggleUMKMFields() {
        const type = document.getElementById('crudItemType').value;
        const umkmFields = document.getElementById('umkmFields');
        const alamatInput = document.getElementById('crudAlamat');
        if (type === 'umkm') {
            umkmFields.style.display = 'block';
            alamatInput.required = true;
        } else {
            umkmFields.style.display = 'none';
            alamatInput.required = false;
        }
    }

    function handleCrudFormSubmit(event) {
        event.preventDefault();
        const id = document.getElementById('crudItemId').value;
        const type = document.getElementById('crudItemType').value;
        const fasilitasValue = document.getElementById('crudFasilitas').value;
        const jamOperasionalValue = document.getElementById('crudJamOperasional').value;
        const newItemData = {
            id: id || `${type}-${Date.now()}`,
            nama: document.getElementById('crudNama').value,
            lat: parseFloat(document.getElementById('crudLat').value),
            lng: parseFloat(document.getElementById('crudLng').value),
            deskripsi_detail: document.getElementById('crudDeskripsi').value,
            deskripsi_singkat: document.getElementById('crudDeskripsi').value.substring(0, 50) + '...',
            kategori: document.getElementById('crudKategori').value,
            jam_operasional: jamOperasionalValue || "Informasi belum tersedia",
            fasilitas: fasilitasValue ? fasilitasValue.split(',').map(f => f.trim()).filter(f => f) : ["Informasi belum tersedia"],
            iconClass: "fa-map-marker-alt"
        };
        if (type === 'wisata') {
            newItemData.gambar = [];
            newItemData.iconColor = "var(--secondary-color)";
            if (id) {
                const index = dataWisata.findIndex(item => item.id === id);
                dataWisata[index] = { ...dataWisata[index], ...newItemData };
            } else {
                dataWisata.push(newItemData);
            }
        } else {
             newItemData.alamat_lengkap = document.getElementById('crudAlamat').value;
             newItemData.kontak_person = document.getElementById('crudKontak').value;
             newItemData.iconColor = "var(--accent-color)";
            if (id) {
                const index = dataUMKM.findIndex(item => item.id === id);
                dataUMKM[index] = { ...dataUMKM[index], ...newItemData };
            } else {
                dataUMKM.push(newItemData);
            }
        }
        saveDataToLocalStorage();
        populateSidebarAndMarkers();
        document.getElementById('crudModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }


    // --- UI & MAP FUNCTIONS ---
    function createCustomLeafletIcon(iconClass, color) {
        return L.divIcon({
            html: `<i class="fas ${iconClass}" style="color: ${color};"></i>`,
            className: 'custom-leaflet-div-icon',
            iconSize: [30, 30], 
            iconAnchor: [15, 30], 
            popupAnchor: [0, -30]  
        });
    }
    
    function handleRouteButtonClick(lat, lng, nama) {
        if (modal) {
            modal.style.display = "none";
        }
        document.body.style.overflow = 'auto';

        if (!navigator.geolocation) {
            alert("Geolocation tidak didukung oleh browser Anda.");
            return;
        }

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const userLat = position.coords.latitude;
                const userLng = position.coords.longitude;
                const startPoint = L.latLng(userLat, userLng);
                const endPoint = L.latLng(lat, lng);

                if (routingControl) {
                    map.removeControl(routingControl);
                }
                
                routingControl = L.Routing.control({
                    waypoints: [
                        L.Routing.waypoint(startPoint, "Lokasi Anda"),
                        L.Routing.waypoint(endPoint, nama)
                    ],
                    routeWhileDragging: true,
                    geocoder: L.Control.Geocoder.nominatim(),
                    addWaypoints: false,
                    draggableWaypoints: false,
                    fitSelectedRoutes: true,
                    show: true,
                    lineOptions: {
                        styles: [{ color: 'var(--primary-color)', opacity: 0.8, weight: 6 }]
                    },
                    createMarker: function(i, waypoint, n) {
                        const markerIcon = i === 0 
                            ? createCustomLeafletIcon('fa-location-arrow', 'var(--primary-color)') 
                            : createCustomLeafletIcon('fa-map-marker-alt', 'var(--secondary-color)');
                        return L.marker(waypoint.latLng, { icon: markerIcon });
                    }
                }).addTo(map);
            },
            () => {
                alert("Tidak dapat mengambil lokasi Anda. Pastikan Anda mengizinkan akses lokasi.");
            },
            { enableHighAccuracy: true }
        );
    }

    function openModalWithDetails(item, type) {
        if (!modal || !modalTitle || !modalBodyContent) { return; }
        const actionButtonsHtml = `
            <div class="route-button-container" style="display: flex; gap: 10px;">
                <button class="route-button" style="flex: 1;" onclick="handleRouteButtonClick(${item.lat}, ${item.lng}, '${item.nama.replace(/'/g, "\\'")}')"><i class="fas fa-directions"></i> Rute</button>
                <button class="route-button" style="flex: 1; background-color: var(--accent-color);" onclick="showEditForm('${item.id}', '${type}')"><i class="fas fa-edit"></i> Edit</button>
                <button class="route-button" style="flex: 1; background-color: #ef4444;" onclick="handleDeleteItem('${item.id}', '${type}')"><i class="fas fa-trash"></i> Hapus</button>
            </div>`;
        let contentHtml = '';
        let titleIconHtml = `<i class="fas fa-map-marker-alt" style="color:${item.iconColor}"></i> ${item.nama}`;
        const fasilitasHtml = Array.isArray(item.fasilitas) && item.fasilitas.length > 0 && item.fasilitas[0] !== "Informasi belum tersedia"
            ? `<h4><i class="fas fa-concierge-bell"></i> Fasilitas</h4> <ul>${item.fasilitas.map(f => `<li><i class="fas fa-check-circle fa-li-icon"></i>${f}</li>`).join('')}</ul>`
            : '<h4><i class="fas fa-concierge-bell"></i> Fasilitas</h4><p>Informasi fasilitas belum tersedia.</p>';
        if (type === 'wisata') {
            contentHtml = `<img src="${item.gambar && item.gambar.length > 0 ? item.gambar[0] : ''}" alt="${item.nama}" class="main-image" onerror="this.style.display='none';">
                <h4><i class="fas fa-info-circle"></i> Deskripsi</h4> <p>${item.deskripsi_detail}</p>
                <h4><i class="fas fa-tags"></i> Kategori</h4> <p>${item.kategori}</p>
                ${fasilitasHtml}
                <h4><i class="fas fa-clock"></i> Jam Operasional</h4> <p>${item.jam_operasional}</p>
                ${actionButtonsHtml}`;
        } else {
            contentHtml = `<h4><i class="fas fa-info-circle"></i> Deskripsi</h4> <p>${item.deskripsi_detail}</p>
                <h4><i class="fas fa-store-alt"></i> Kategori</h4> <p>${item.kategori}</p>
                <h4><i class="fas fa-map-marker-alt"></i> Alamat</h4> <p>${item.alamat_lengkap}</p>
                ${fasilitasHtml}
                <h4><i class="fas fa-clock"></i> Jam Operasional</h4> <p>${item.jam_operasional}</p>
                <h4><i class="fas fa-phone-alt"></i> Kontak</h4> <p>${item.kontak_person || 'Tidak tersedia'}</p>
                ${actionButtonsHtml}`;
        }
        modalTitle.innerHTML = titleIconHtml;
        modalBodyContent.innerHTML = contentHtml;
        modal.style.display = "block";
        document.body.style.overflow = 'hidden';
    }

    function populateSidebarAndMarkers() {
        if (!featureList || !wisataLayerGroup || !umkmLayerGroup) return;
        featureList.innerHTML = ''; 
        wisataLayerGroup.clearLayers(); 
        umkmLayerGroup.clearLayers();   
        const allItems = [...dataWisata.map(item => ({...item, type: 'wisata'})), ...dataUMKM.map(item => ({...item, type: 'umkm'}))];
        allItems.sort((a, b) => a.nama.localeCompare(b.nama));
        allItems.forEach(item => {
            const layerGroup = item.type === 'wisata' ? wisataLayerGroup : umkmLayerGroup;
            const marker = L.marker([item.lat, item.lng], { icon: createCustomLeafletIcon(item.iconClass, item.iconColor) });
            marker.on('click', () => openModalWithDetails(item, item.type));
            layerGroup.addLayer(marker); 
            const listItem = createSidebarItem(item, item.type);
            featureList.appendChild(listItem);
        });
        document.getElementById('total-wisata').textContent = dataWisata.length;
        document.getElementById('total-umkm').textContent = dataUMKM.length;
    }
    
    function createSidebarItem(item, type) {
        const listItem = document.createElement('div');
        listItem.className = 'sidebar-item';
        listItem.innerHTML = `<i class="fas ${item.iconClass} fa-icon" style="color: ${item.iconColor};"></i> <span class="item-name">${item.nama}</span><span class="item-type">${type === 'wisata' ? 'Wisata' : 'UMKM'} - ${item.kategori}</span>`;
        listItem.onclick = () => {
            map.flyTo([item.lat, item.lng], 16, { animate: true, duration: 1 });
            setTimeout(() => { openModalWithDetails(item, type); }, 600); 
        };
        return listItem;
    }
    
    function initModal(modalElement, closeButtonClass) {
        const modalToInit = document.getElementById(modalElement);
        const closeBtn = modalToInit.querySelector(closeButtonClass);
        if (!modalToInit || !closeBtn) return;
        const closeModal = () => { 
            modalToInit.style.display = "none"; 
            document.body.style.overflow = 'auto';
        };
        closeBtn.onclick = closeModal;
        window.addEventListener('click', (event) => { if (event.target == modalToInit) { closeModal(); } });
        document.addEventListener('keydown', (event) => { if (event.key === "Escape" && modalToInit.style.display === "block") { closeModal(); } });
    }

    function locateUser() {
        if (!navigator.geolocation) {
            alert("Geolocation tidak didukung oleh browser Anda.");
            return;
        }
        navigator.geolocation.getCurrentPosition(position => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const userLatLng = L.latLng(lat, lng);
            map.flyTo(userLatLng, 16);
            if (!userMarker) {
                userMarker = L.marker(userLatLng, {
                    icon: createCustomLeafletIcon('fa-location-arrow', 'var(--primary-color)')
                }).addTo(map);
            } else {
                userMarker.setLatLng(userLatLng);
            }
            userMarker.bindPopup('<b>Anda di sini</b>').openPopup();
        }, () => {
            alert("Tidak dapat mengambil lokasi Anda. Pastikan Anda mengizinkan akses lokasi.");
        }, { enableHighAccuracy: true });
    }

    // --- APPLICATION INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', function() {
        loadDataFromLocalStorage();

        featureList = document.getElementById('feature-list');
        modal = document.getElementById('infoModal');
        modalTitle = document.getElementById('modalTitle');
        modalBodyContent = document.getElementById('modalBodyContent');

        if (!featureList || !modal || !modalTitle || !modalBodyContent) {
            console.error("Elemen DOM penting tidak ditemukan.");
            return; 
        }

        initModal('infoModal', '.close-button');
        initModal('crudModal', '.crud-close-button');

        const disclaimerModal = document.getElementById('disclaimerModal');
        const disclaimerCloseBtn = document.getElementById('disclaimerCloseBtn');
        if (!sessionStorage.getItem('disclaimerAccepted')) {
            disclaimerModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        disclaimerCloseBtn.onclick = function() {
            disclaimerModal.style.display = 'none';
            sessionStorage.setItem('disclaimerAccepted', 'true'); 
            document.body.style.overflow = 'auto';
        }

        map = L.map('map', { zoomControl: false }).setView(initialCoords, initialZoom);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        const toggleBtn = document.getElementById('toggle-sidebar-btn');
        const sidebar = document.getElementById('sidebar');
        if (toggleBtn && sidebar) {
            toggleBtn.addEventListener('click', () => {
                sidebar.classList.toggle('closed');
                setTimeout(() => map.invalidateSize(), 300);
            });
        }
        
        wisataLayerGroup = L.layerGroup().addTo(map); 
        umkmLayerGroup = L.layerGroup().addTo(map);   

        // Add Map Controls
        L.control.zoom({ position: 'topleft' }).addTo(map);
        L.Control.geocoder({ defaultMarkGeocode: false, placeholder: 'Cari alamat...', position: 'topleft' })
            .on('markgeocode', e => map.fitBounds(e.geocode.bbox))
            .addTo(map);
        
        // **FITUR BARU: Tombol Home (Reset View)**
        L.Control.ResetView = L.Control.extend({
            onAdd: function(map) {
                var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                container.innerHTML = '<a href="#" title="Kembali ke Tampilan Awal"><i class="fas fa-home"></i></a>';
                L.DomEvent.on(container, 'click', function (e) {
                    L.DomEvent.stop(e);
                    if (routingControl) {
                        map.removeControl(routingControl);
                        routingControl = null;
                    }
                    if (userMarker) {
                        map.removeLayer(userMarker);
                        userMarker = null;
                    }
                    map.setView(initialCoords, initialZoom);
                });
                return container;
            }
        });
        L.control.resetView = (opts) => new L.Control.ResetView(opts);
        L.control.resetView({ position: 'topleft' }).addTo(map);

        // **FITUR BARU: Tombol Geolokasi**
        L.Control.MyLocator = L.Control.extend({
            onAdd: function(map) {
                var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                container.innerHTML = '<a href="#" title="Temukan Lokasi Saya"><i class="fas fa-crosshairs"></i></a>';
                L.DomEvent.on(container, 'click', function (e) {
                    L.DomEvent.stop(e);
                    locateUser();
                });
                return container;
            }
        });
        L.control.myLocator = (opts) => new L.Control.MyLocator(opts);
        L.control.myLocator({ position: 'topleft' }).addTo(map);
        
        L.control.scale({ imperial: false, position: 'bottomleft' }).addTo(map);
        
        const overlayMaps = {
            "<i class='fas fa-map-marker-alt' style='color:var(--secondary-color)'></i> Destinasi Wisata": wisataLayerGroup,
            "<i class='fas fa-map-marker-alt' style='color:var(--accent-color)'></i> UMKM Lokal": umkmLayerGroup
        };
        layerControl = L.control.layers(null, overlayMaps, { collapsed: false });
        layerControl.addTo(map); 

        // Setup CRUD Event Listeners
        document.getElementById('addDataBtn').addEventListener('click', showAddForm);
        document.getElementById('crudForm').addEventListener('submit', handleCrudFormSubmit);
        document.getElementById('crudItemType').addEventListener('change', toggleUMKMFields);
        map.on('click', function(e) {
            if (document.getElementById('crudModal').style.display === 'block') {
                document.getElementById('crudLat').value = e.latlng.lat.toFixed(6);
                document.getElementById('crudLng').value = e.latlng.lng.toFixed(6);
            }
        });

        // Final population after everything is ready
        map.whenReady(function() {
            document.querySelector('.filter-controls').appendChild(layerControl.getContainer());
            populateSidebarAndMarkers(); 
        });  
    });
    </script>
</body>
</html>